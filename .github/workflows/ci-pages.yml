# ===============================================
# Custom CI + Deploy Workflow
# Credits: Luis
# Workflow made by ChatGPT
# ===============================================

name: CI + Custom Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------
      # Checkout repository
      # -------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------
      # Setup Node.js
      # -------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # -------------------------------------------
      # Backend (optional)
      # -------------------------------------------
      - name: Backend install, build & test
        run: |
          if [ -d backend ] && [ -f backend/package.json ]; then
            cd backend
            npm install
            npm run build --if-present
            npm test --if-present
            cd ..
          else
            echo "No backend folder found, skipping backend step"
          fi

      # -------------------------------------------
      # Frontend install
      # -------------------------------------------
      - name: Frontend install
        run: |
          if [ -d frontend ] && [ -f frontend/package.json ]; then
            cd frontend
            npm install
            cd ..
          elif [ -f package.json ]; then
            npm install
          else
            echo "No frontend package.json found"
          fi

      # -------------------------------------------
      # Frontend build
      # -------------------------------------------
      - name: Frontend build
        run: |
          if [ -d frontend ] && [ -f frontend/package.json ]; then
            cd frontend
            npm run build
            cd ..
          elif [ -f package.json ]; then
            npm run build
          else
            echo "No frontend build step"
          fi

      # -------------------------------------------
      # Prepare deploy directory
      # -------------------------------------------
      - name: Prepare deploy folder
        run: |
          rm -rf deploy
          mkdir deploy

          if [ -d frontend/dist ]; then
            cp -r frontend/dist/* deploy/
          elif [ -d frontend/build ]; then
            cp -r frontend/build/* deploy/
          elif [ -d dist ]; then
            cp -r dist/* deploy/
          elif [ -d build ]; then
            cp -r build/* deploy/
          else
            echo "‚ùå No frontend build output found"
            exit 1
          fi

      # -------------------------------------------
      # Deploy to custom branch
      # -------------------------------------------
      - name: Deploy to deploy branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan deploy
          git rm -rf .
          cp -r deploy/* .
          touch .nojekyll

          git add .
          git commit -m "Deploy site (auto)"
          git push origin deploy --force
